%global pom_version @@POM_VERSION@@
%global mvn_settings @@MVN_SETTINGS@@

Name: storm-native-libs
Version: 1.0.0
Release: 1%{?dist}
Summary: The StoRM backend server native libraries

Group: Applications/Internet
License: ASL 2.0
URL: https://github.com/italiangrid/storm-native-libs
Source: %{name}-%{version}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

BuildRequires: libtool
BuildRequires: pkgconfig
BuildRequires: maven
BuildRequires: jpackage-utils
BuildRequires: swig
BuildRequires: libacl-devel
BuildRequires: lcmaps-without-gsi-devel
BuildRequires: lcmaps-interface
BuildRequires: java-1.6.0-openjdk-devel

Requires: java-1.6.0-openjdk
Requires: lcmaps-without-gsi
Requires: libacl

%description
This package provides the StoRM backend native libraries.

%prep
%setup -q -n storm-native-libs 

%build
pushd native
./bootstrap
%configure --with-java_home=%{java_home}
make
popd

mvn @@MVN_SETTINGS@@ -DskipTests -U package

%install
rm -rf $RPM_BUILD_ROOT
pushd native
make install DESTDIR=$RPM_BUILD_ROOT
popd

install -dm 755 $RPM_BUILD_ROOT%{_javadir}/storm-backend-server
install -m 644 target/storm-native-interface-%{pom_version}.jar \
    $RPM_BUILD_ROOT%{_javadir}/storm-backend-server

# Move libraries
install -dm 755 $RPM_BUILD_ROOT%{_libdir}/storm-backend-server
rm -f $RPM_BUILD_ROOT%{_libdir}/libgpfs.*
rm -f $RPM_BUILD_ROOT%{_libdir}/*.0
rm -f $RPM_BUILD_ROOT%{_libdir}/*.a
rm -f $RPM_BUILD_ROOT%{_libdir}/*.la
mv $RPM_BUILD_ROOT%{_libdir}/*.so $RPM_BUILD_ROOT%{_libdir}/storm-backend-server

# Remove debuginfo stuff, if needed
#rm -rf $RPM_BUILD_ROOT%{_usrsrc}
#rm -rf $RPM_BUILD_ROOT%{_usr}/lib/debug
%clean
rm -rf $RPM_BUILD_ROOT

%files
%defattr(-,root,root,-)
%{_javadir}/storm-backend-server/storm-native-interface-%{pom_version}.jar

%dir %{_libdir}/storm-backend-server

%{_libdir}/storm-backend-server/libposixapi_interface.so
%{_libdir}/storm-backend-server/libgpfsapi_interface.so
%{_libdir}/storm-backend-server/libstorm_cutil.so
%{_libdir}/storm-backend-server/libstorm_lcmaps.so

# %pre
# %preun
# %post

%changelog
* Fri Mar 1 2013 Andrea Ceccanti <andrea.ceccanti at cnaf.infn.it> - 1.0.0-1
- StoRM native libraries first packaging
